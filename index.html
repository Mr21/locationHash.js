<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title></title>
<style>
body {
	margin: 20px;
	font: 12px sans-serif;
	}
a {
	display: inline-block;
	margin: 0 .5em .5em 0;
	padding: .5em 1em;
	border-radius: 2px;
	background: #ddd;
	text-decoration: none;
	}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="locationHash.js"></script>
<script>

window.onhashchange = function() {
	console.log('location.hash: "' + location.hash + '"')
};

window.onload = function() {

	// create some links to test
	function createA(href, sep) {
		$('<a href="##' + href + '">')
			.text(href)
			.appendTo(document.body);
		if (sep)
			$("<br/>").appendTo(document.body);
	}

	createA("add(foo)");
	createA("add(foo, lish)");
	createA("toggle(foo, bar)");
	createA("sub(foo)", true);

	createA("add(plop)");
	createA("add(plop, 21)");
	createA("add(plop, 42)");
	createA("sub(plop)");
	createA("toggle(plop)");
	createA("toggle(plop, 21)", true);

	// # .watch()
	var
		jq_kikoo = $("<b>").appendTo($("<div>").text("#kikoo = ").appendTo(document.body)),
		jq_foo   = $("<b>").appendTo($("<div>").text("#foo = ").appendTo(document.body)),
		jq_plop  = $("<b>").appendTo($("<div>").text("#plop = ").appendTo(document.body)),
		whatValue = function(v) {
			return typeof v === "string"
				? '"'   + v + '"'
				: '<i>' + v + '</i>';
		};

	createA("add(vA),add(vB)");
	createA("add(vA, 1),add(vB, 2)");
	createA("toggle(vA, 2),toggle(vB, 1)");
	createA("sub(vA),sub(vB)", true);

	var
		jq_vA    = $("<b>").appendTo($("<div>").text("#vA = ").appendTo(document.body)),
		jq_vB    = $("<b>").appendTo($("<div>").text("#vB = ").appendTo(document.body)),
		jq_unwatchBtn = $("<a href='#'>")
			.appendTo(document.body)
			.click(function() {
				if (!this.watch_toggle) {
					locationHash.unwatch("vA", "vB");
					this.textContent = ".watch({vA: ..., vB: ...})";
				} else {
					locationHash.watch({
						vA: function(v) { jq_vA.html(whatValue(v)); },
						vB: function(v) { jq_vB.html(whatValue(v)); }
					});
					this.textContent = ".unwatch('vA', 'vB')";
				}
				this.watch_toggle = !this.watch_toggle;
				return false;
			})
			.click();

	// # two .watch() separate
	locationHash.watch({
		foo:   function(v) { jq_foo.html(whatValue(v)); },
		kikoo: function(v) { jq_kikoo.html(whatValue(v)); }
	});
	locationHash.watch({
		plop:  function(v) { jq_plop.html(whatValue(v)); }
	});

	// # unit tests
	var testsPassed = 0,
		testsTotal = 0;
	function equal(key, val) {
		++testsTotal;
		if (locationHash.data[key] !== val)
			console.error(key + "=" + locationHash.data[key] + " (instead of " + val + ").");
		else
			++testsPassed;
	}

	equal("r1", undefined);
	locationHash.change("add(r1)");
		equal("r1", true);
	locationHash.change(" 	 add	 ( 	azAZ_-09  	,	 _a-z-09-AZ	)	");
		equal("azAZ_-09", "_a-z-09-AZ");
	locationHash.change(" 	 add	 ( 	azAZ_-09  	,	 ZA_a-z-90	)  ,  sub (  r1 	),toggle(r2,2)	");
		equal("azAZ_-09", "ZA_a-z-90");
		equal("r1", undefined);
		equal("r2", "2");

	equal("t1", undefined);
	locationHash.change("toggle(t1)");                                     equal("t1", true);
	locationHash.change("toggle(t1)");                                     equal("t1", undefined);
	locationHash.change("toggle(t1)");                                     equal("t1", true);
	locationHash.change("toggle(t1), toggle(t1)");                         equal("t1", true);
	locationHash.change("toggle(t1), toggle(t1), toggle(t1)");             equal("t1", undefined);
	locationHash.change("toggle(t1), toggle(t1), toggle(t1), toggle(t1)"); equal("t1", undefined);

	equal("t2", undefined);
	locationHash.change("add(t2, plop)");                    equal("t2", "plop");
	locationHash.change("add(t2, okay)");                    equal("t2", "okay");
	locationHash.change("add(t2)");                          equal("t2", true);
	locationHash.change("add(t2, 0)");                       equal("t2", "0");
	locationHash.change("toggle(t2, 0)");                    equal("t2", undefined);
	locationHash.change("toggle(t2, foo)");                  equal("t2", "foo");
	locationHash.change("toggle(t2, bar)");                  equal("t2", "bar");
	locationHash.change("toggle(t2, foo)");                  equal("t2", "foo");
	locationHash.change("toggle(t2, foo)");                  equal("t2", undefined);
	locationHash.change("add(t2, lol)");                     equal("t2", "lol");
	locationHash.change("toggle(t2, lol), toggle(t2, lol)"); equal("t2", "lol");

	equal("t3", undefined);
	locationHash.change("add(t3)");         equal("t3", true);
	locationHash.change("sub(t3)");         equal("t3", undefined);
	locationHash.change("sub(t3)");         equal("t3", undefined);
	locationHash.change("sub(t3)");         equal("t3", undefined);
	locationHash.change("toggle(t3)");      equal("t3", true);
	locationHash.change("toggle(t3)");      equal("t3", undefined);
	locationHash.change("toggle(t3, str)"); equal("t3", "str");
	locationHash.change("toggle(t3, 21)");  equal("t3", "21");

	equal("t4", undefined);
	locationHash.change("add(t4),add(t4,kikoo)");
		equal("t4", "kikoo");
	locationHash.change("toggle(t4,kikoo),add(t5,5)");
		equal("t4", undefined);
		equal("t5", "5");
	locationHash.change("sub(t5),add(t6),toggle(t7),toggle(t8,8)");
		equal("t5", undefined);
		equal("t6", true);
		equal("t7", true);
		equal("t8", "8");

	// clean
	locationHash
		.sub("azAZ_-09")
		.sub("r2")
		.sub("t2")
		.sub("t3")
		.sub("t6")
		.sub("t7")
		.sub("t8")

	console.log("Tests passed : " + testsPassed + " / " + testsTotal);
};
</script>
</head>
<body>

	<div>Open the <code>console</code> to see when the <code>location.hash</code> is updated.</div>
	<br/>

	<!-- a link who is in the HTML already -->
	<a href="##toggle(kikoo)">toggle(kikoo)</a>
	<br/>

</body>
</html>
